#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'optparse'
require 'apple_peeler'
require 'app_store_connect'
require 'tsort'

class Todo
  include TSort

  def initialize
    @dep = {}
    @dep.default = []
  end 

  def tsort_each_child(node, &block)
    @dep[node].each(&block)
  end
end 

options = {}
OptionParser.new do |parser|
  parser.on('-fFILENAME', '--filename=FILENAME') do |filename|
    options[:filename] = filename
  end
end.parse!(ARGV)

documentation = ApplePeeler::Documentation.new(
  on_documentation: proc { |d| print '.' }
)

documentation.load!

lines = []
cache = Hash.new
cache.default = []
implemented_urls_by_http_method = AppStoreConnect::SCHEMA
  .web_service_endpoints
  .reduce(cache) { |acc, wse| 
    acc[wse.http_method] << wse.url 
    acc
  }

documentation_by_groups = documentation.documentation_by_type[:web_service_endpoint].group_by(&:group)

documentation_by_groups.each do |groups, docs|
  lines << ""
  lines << "### #{groups}"

  docs.each do |d|
    mark = if implemented_urls_by_http_method[d.http_method].detect { |u| u == d.url }
             "X"
           else 
             " "
           end 
    lines << "- [#{mark}] #{d.heading}"
  end
end

File.write(options[:filename], lines.join("\n"))
